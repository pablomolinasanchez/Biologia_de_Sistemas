---
title: "Análisis con iGraph de los genes involucrados en la Trombosis Arterial"
author: "Pablo Molina Sánchez y Hugo Ávalos de Rorthais"
date: "`r format(Sys.time(), '%A %d, %B %Y. %H.%M.%S')`"
output: 
  html_document:
    toc: yes
    toc_float: yes
    fig_caption: yes
    number_sections: yes
    theme: journal
    df_print: paged
  pdf_document:
    toc: yes
    fig_caption: yes
    df_print: kable
---
# Librerías y Path{.tabset}
## Librerías
```{r, warning=FALSE,message=FALSE}
library(DOSE)
library(clusterProfiler)
library(org.Hs.eg.db)
library(devtools)
library(dplyr)
library(igraph)
library(ggplot2)
library(zoo)
library(linkcomm)
```
##Path
```{r}

```
# Creación del grafo{.tabset}
```{r}
library(igraph)
nodes<-read.csv("string_node_degrees.tsv",sep ="")
links<-read.csv("string_interactions.tsv",sep="")
net <- graph_from_data_frame(d=links,vertices=nodes, directed=T)
```
## Genes involucrados y sus iteracciones
```{r}
V(net)$size<-V(net)$node_degree
png("../results/Análisis_Grado/01_NetworkGenesInvolucrados.png")
plot(net,layout=layout_nicely, edge.arrow.size=0.2, edge.curved=0.1, vertex.frame.color="black",vertex.label=V(net)$id, vertex.label.color="black", vertex.label.cex=0.7)
```

## ¿Cuál es el gen con más grado y, por tanto, con más conexiones y más relevante para la trombosis arterial?
```{r}
degreeMax<-max(V(net)$node_degree)
dir <- paste("../results/Análisis_Grado/02_GenMayorGrado.txt", sep = "")
mayor_grado<-V(net)$name[V(net)$node_degree==degreeMax]
write.table(mayor_grado,dir)
```

Vemos que el IL10 es el gen con más grado y por tanto más importante

## ¿Con qué gen guarda mayor relación IL10?
```{r}
news.path <- shortest_paths(net, from = V(net), to  = 'IL10',output = "both")
ecol <- rep("gray0", ecount(net))
ecol[unlist(news.path$epath)] <- "orange"
ew <- rep(2, ecount(net))
ew[unlist(news.path$epath)] <- 4
vcol <- rep("gray40", vcount(net))
vcol[unlist(news.path$vpath)] <- "gold"
png("../results/Análisis_Grado/03_MayorRelacionConIL10.png")
plot(net,layout=layout_nicely, vertex.color=vcol, edge.color=ecol, edge.width=ew, edge.arrow.mode=0)
```
El gen que guarda mayor relación con IL10 es AKT1


# Network Propagation

Nos apoyamos en STRINGDB para incrementar nuestro reactoma con no más de 50 genes.
```{r}
nodes_prop<-read.csv("string_node_degrees_prop.tsv",sep ="")
links_prop<-read.csv("string_interactions_prop.tsv",sep="")
net_prop <- graph_from_data_frame(d=links_prop,vertices=nodes_prop, directed=T)

```
# Comunidades {.tabset}
## Link communities
```{r}
library(linkcomm)
# Convert to dataframe to use linkcomm
lc<- igraph::as_data_frame(net_prop, what="edges") 
lc<-lc[,c(1,2,13)]
lc
# get the linkcomms
hits.network_lc <- getLinkCommunities(lc , hcmethod = "single")
print(hits.network_lc)
png("../results/Análisis_Comunidades/01_NetworkComunidades.png")
plot(hits.network_lc, type = "graph", layout = layout.fruchterman.reingold, ewidth = 2, vlabel.cex = 0.5)
```
## Comunidades más grandes
```{r}
png("../results/Análisis_Comunidades/02_ComunidadesMayorTamano.png")
par(mfrow = c(2,1))
pie(hits.network_lc$clustsizes[hits.network_lc$clustsizes > 8], radius = 1, main = "Tama?os de las comunidades m?s grandes")
barplot(hits.network_lc$clustsizes[hits.network_lc$clustsizes > 8], xlab = "Comunidades", ylab = "Tama?o (num genes)")
par(mfrow = c(1,1))
```
## Genes más conectados con otras comunidades
```{r, warning=FALSE,message=FALSE}

png("../results/Análisis_Comunidades/03_GenesMasCOnectadosOtrasComunidades.png")
plot(hits.network_lc, type = "members")

```
LOs genes más importantes, ya que unen comunidades y son de gran interés e importancia en la red, se encuentran en su totalidad en la comunidad 16, por lo que podemos determinar de que será la comunidad más relevante y la cuál llevará a cabo la función biológica principal

## IMportancia genes según su centralidad
```{r}
cc <- getCommunityCentrality(hits.network_lc)
print(head(sort(cc, decreasing = TRUE)))
png("../results/Análisis_Comunidades/04_GenesMayorCentralidad.png")
barplot(t(head(sort(cc, decreasing= TRUE))), xlab = "genes", ylab = "Community centrality", main = "Genes con mayor CC", ylim = c(0,10))

```
Podemos observar que tanto TP53 como AKT1 e IL10 (genes iniciales de la trombosis arterial) tienen una frecuencia bastante alta en la que cada gen aparece en todos los caminos más cortos entre dos nodos. Es decir, estos genes representan proteínas/procesos/iniciadores importantes en la formación de un trombo arterial. 
## COmunidades Independientes
```{r}

# Nested communities: Son aquellas comunidades que son independientes respecto a otras
getAllNestedComm(hits.network_lc)
png("../results/Análisis_Comunidades/05_Comunidades_Independientes.png")
plot(hits.network_lc, type = "graph", clusterids = c(9, 15))
```
Las comunidades 9 y 15 son las únicas comunidades independientes de nuestra enfermedad, lo que hace que...



# Enriquecimientos de las comunidades{.tabset}
## Función para el enriquecimiento de los procesos biológicos con GO
```{r}
data(geneList, package="DOSE")
overrep_enrichment_GO <- function(gene,universe,Db, ont, pAdjustMethod, p,q) {
  ego <- enrichGO(gene          = gene,
                  universe      = universe,
                  OrgDb         = Db,
                  ont           = ont,
                  pAdjustMethod = pAdjustMethod,
                  pvalueCutoff  = p,
                  qvalueCutoff  = q,
                  readable      = TRUE)
  return (ego)
}
```
## Comunidad 1 
```{r}
community_1<-getNodesIn(hits.network_lc, clusterids = c(1))
community_1<-bitr(community_1, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)
go_1<-overrep_enrichment_GO(community_1$ENTREZID,geneList,org.Hs.eg.db,"BP","BH",0.05,0.05)
dir <- paste("../results/Enriquecimientos/Análisis_funcional_Comunidades_1.csv", sep = "")
write.csv(go_1, dir)
head(go_1)
```

## Comunidad 2 
```{r}
community_2<-getNodesIn(hits.network_lc, clusterids = c(2))
community_2<-bitr(community_2, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)
go_2<-overrep_enrichment_GO(community_2$ENTREZID,geneList,org.Hs.eg.db,"BP","BH",0.05,0.05)
dir <- paste("../results/Enriquecimientos/Análisis_funcional_Comunidades_2.csv", sep = "")
write.csv(go_2, dir)
head(go_2)
```

## Comunidad 3 
```{r}
community_3<-getNodesIn(hits.network_lc, clusterids = c(3))
community_3<-bitr(community_3, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)
go_3<-overrep_enrichment_GO(community_3$ENTREZID,geneList,org.Hs.eg.db,"BP","BH",0.05,0.05)
dir <- paste("../results/Enriquecimientos/Análisis_funcional_Comunidades_3.csv", sep = "")
write.csv(go_3, dir)
head(go_3)
```
## Comunidad 4 
```{r}
community_4<-getNodesIn(hits.network_lc, clusterids = c(4))
community_4<-bitr(community_4, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)
go_4<-overrep_enrichment_GO(community_4$ENTREZID,geneList,org.Hs.eg.db,"BP","BH",0.05,0.05)
dir <- paste("../results/Enriquecimientos/Análisis_funcional_Comunidades_4.csv", sep = "")
write.csv(go_4, dir)
head(go_4)
```
## Comunidad 5 
```{r}
community_5<-getNodesIn(hits.network_lc, clusterids = c(5))
community_5<-bitr(community_5, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)
go_5<-overrep_enrichment_GO(community_5$ENTREZID,geneList,org.Hs.eg.db,"BP","BH",0.05,0.05)
dir <- paste("../results/Enriquecimientos/Análisis_funcional_Comunidades_5.csv", sep = "")
write.csv(go_5, dir)
head(go_5)
```
## Comunidad 6 
```{r}
community_6<-getNodesIn(hits.network_lc, clusterids = c(6))
community_6<-bitr(community_6, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)
go_6<-overrep_enrichment_GO(community_6$ENTREZID,geneList,org.Hs.eg.db,"BP","BH",0.05,0.05)
dir <- paste("../results/Enriquecimientos/Análisis_funcional_Comunidades_6.csv", sep = "")
write.csv(go_6, dir)
head(go_6)
```
## Comunidad 7 
```{r}
community_7<-getNodesIn(hits.network_lc, clusterids = c(7))
community_7<-bitr(community_7, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)
go_7<-overrep_enrichment_GO(community_7$ENTREZID,geneList,org.Hs.eg.db,"BP","BH",0.05,0.05)
dir <- paste("../results/Enriquecimientos/Análisis_funcional_Comunidades_7.csv", sep = "")
write.csv(go_7, dir)
head(go_7)
```
## Comunidad 8 
```{r}
community_8<-getNodesIn(hits.network_lc, clusterids = c(8))
community_8<-bitr(community_8, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)
go_8<-overrep_enrichment_GO(community_8$ENTREZID,geneList,org.Hs.eg.db,"BP","BH",0.05,0.05)
dir <- paste("../results/Enriquecimientos/Análisis_funcional_Comunidades_8.csv", sep = "")
write.csv(go_8, dir)
head(go_8)
```
## Comunidad 9 (independiente)
```{r}
community_9<-getNodesIn(hits.network_lc, clusterids = c(9))
community_9<-bitr(community_9, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)
go_9<-overrep_enrichment_GO(community_9$ENTREZID,geneList,org.Hs.eg.db,"BP","BH",0.05,0.05)
dir <- paste("../results/Enriquecimientos/Análisis_funcional_Comunidades_9.csv", sep = "")
write.csv(go_9, dir)
head(go_9)
```
## Comunidad 10 
```{r}
community_10<-getNodesIn(hits.network_lc, clusterids = c(10))
community_10<-bitr(community_10, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)
go_10<-overrep_enrichment_GO(community_10$ENTREZID,geneList,org.Hs.eg.db,"BP","BH",0.05,0.05)
dir <- paste("../results/Enriquecimientos/Análisis_funcional_Comunidades_10.csv", sep = "")
write.csv(go_10, dir)
head(go_10)
```
## Comunidad 11 
```{r}
community_11<-getNodesIn(hits.network_lc, clusterids = c(11))
community_11<-bitr(community_11, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)
go_11<-overrep_enrichment_GO(community_11$ENTREZID,geneList,org.Hs.eg.db,"BP","BH",0.05,0.05)
dir <- paste("../results/Enriquecimientos/Análisis_funcional_Comunidades_11.csv", sep = "")
write.csv(go_11, dir)
head(go_11)
```
## Comunidad 12 
```{r}
community_12<-getNodesIn(hits.network_lc, clusterids = c(12))
community_12<-bitr(community_12, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)
go_12<-overrep_enrichment_GO(community_12$ENTREZID,geneList,org.Hs.eg.db,"BP","BH",0.05,0.05)
dir <- paste("../results/Enriquecimientos/Análisis_funcional_Comunidades_12.csv", sep = "")
write.csv(go_12, dir)
head(go_12)
```
## Comunidad 13 
```{r}
community_13<-getNodesIn(hits.network_lc, clusterids = c(13))
community_13<-bitr(community_13, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)
go_13<-overrep_enrichment_GO(community_13$ENTREZID,geneList,org.Hs.eg.db,"BP","BH",0.05,0.05)
dir <- paste("../results/Enriquecimientos/Análisis_funcional_Comunidades_13.csv", sep = "")
write.csv(go_13, dir)
head(go_13)
```
## Comunidad 14 
```{r}
community_14<-getNodesIn(hits.network_lc, clusterids = c(14))
community_14<-bitr(community_14, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)
go_14<-overrep_enrichment_GO(community_14$ENTREZID,geneList,org.Hs.eg.db,"BP","BH",0.05,0.05)
dir <- paste("../results/Enriquecimientos/Análisis_funcional_Comunidades_14.csv", sep = "")
write.csv(go_14, dir)
head(go_14)
```
## Comunidad 15 (independiente)
```{r}
community_15<-getNodesIn(hits.network_lc, clusterids = c(15))
community_15<-bitr(community_15, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)
go_15<-overrep_enrichment_GO(community_15$ENTREZID,geneList,org.Hs.eg.db,"BP","BH",0.05,0.05)
dir <- paste("../results/Enriquecimientos/Análisis_funcional_Comunidades_15.csv", sep = "")
write.csv(go_15, dir)
head(go_15)
```
## Comunidad 16 
```{r}
community_16<-getNodesIn(hits.network_lc, clusterids = c(16))
community_16<-bitr(community_16, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)
go_16<-overrep_enrichment_GO(community_16$ENTREZID,geneList,org.Hs.eg.db,"BP","BH",0.05,0.05)
dir <- paste("../results/Enriquecimientos/Análisis_funcional_Comunidades_16.csv", sep = "")
write.csv(go_16, dir)
head(go_16)
```
## Comunidad 17 
```{r}
community_17<-getNodesIn(hits.network_lc, clusterids = c(17))
community_17<-bitr(community_17, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)
go_17<-overrep_enrichment_GO(community_17$ENTREZID,geneList,org.Hs.eg.db,"BP","BH",0.05,0.05)
dir <- paste("../results/Enriquecimientos/Análisis_funcional_Comunidades_17.csv", sep = "")
write.csv(go_17, dir)
head(go_17)
```
## Comunidad 18 
```{r}
community_18<-getNodesIn(hits.network_lc, clusterids = c(18))
community_18<-bitr(community_18, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)
go_18<-overrep_enrichment_GO(community_18$ENTREZID,geneList,org.Hs.eg.db,"BP","BH",0.05,0.05)
dir <- paste("../results/Enriquecimientos/Análisis_funcional_Comunidades_18.csv", sep = "")
write.csv(go_18, dir)
head(go_18)
```
# Estudio de la robustez {.tabset}
## Función
```{r message=FALSE, warning=FALSE, include=FALSE}
# definimos las funciones:
# ataque dirigido:
sequential.attacks.targeted <- function(grafo, measure=degree){
  
  q = seq(from=0,to=1,by=0.01)
  g = grafo
  S = max(components(grafo)$csize)/vcount(grafo)
  contador = S
  removalset = NULL
  v = vcount(grafo)
  s = max(components(grafo)$csize)
  for(i in q){
    if(max(components(g)$csize)/vcount(grafo) >0.05){
      removalset <- names(sort(degree(g),decreasing = T)[1:(i*vcount(g))])
      g <- delete.vertices(graph = g, v = removalset)
      S = c(S, max(components(g)$csize)/vcount(grafo))
      v <- c(v, vcount(g))
      s = c(s, max(components(g)$csize))
      contador = max(components(g)$csize)/vcount(grafo)
    }
    
  }
  S.vs.q <- tbl_df(data.frame(cbind(q[1:length(S)],S,s,v)))
  names(S.vs.q) <- c("q", "S", "s", "v")
  return(S.vs.q)
}
# ataque aleatorio
sequential.attacks.random <- function(grafo, measure=degree){
  
  q = seq(from=0,to=1,by=0.01)
  g = grafo
  S = max(components(grafo)$csize)/vcount(grafo)
  contador = S
  removalset = NULL
  v = vcount(grafo)
  s = max(components(grafo)$csize)
  for(i in q){
    if(contador > 0.05 & length(removalset) < vcount(g)/2){
      removalset <- sample(x = V(g)$name, size = 1, replace = F)
      g <- delete.vertices(graph = g, v = removalset)
      S = c(S, max(components(g)$csize)/vcount(grafo))
      v <- c(v, vcount(g))
      s = c(s, max(components(g)$csize))
      contador = max(components(g)$csize)/vcount(grafo)
    }
    
  }
  S.vs.q <- tbl_df(data.frame(cbind(q[1:length(S)],S,s,v)))
  names(S.vs.q) <- c("q", "S", "s", "v")
  return(S.vs.q)
}
#puntuacion robustez dirigido
robustness.targeted2 <- function(grafo, measure=degree){
  
  
  
  q = seq(from=0.01,to=1,by=0.01)
  g = grafo
  S = max(components(grafo)$csize)/vcount(grafo)
  contador = S
  removalset = NULL
  for(i in q){
    if(max(components(g)$csize)/vcount(grafo) >0.05){
      removalset <- names(sort(degree(g),decreasing = T)[1:(i*vcount(g))])
      g <- delete.vertices(graph = g, v = removalset)
      S = c(S, max(components(g)$csize)/vcount(grafo))
      contador = max(components(g)$csize)/vcount(grafo)
    }
  }
  x <- as.numeric(q[1:length(S)])
  y <- as.numeric(S)
  id <- order(x)
  return(sum(diff(x[id])*rollmean(y[id],2)))
} 
#puntuacionrobustez aleatorio
robustness.random2 <- function(grafo, measure=degree){
 
  q = seq(from=0.01,to=1,by=0.01)
  g = grafo
  S = max(components(grafo)$csize)/vcount(grafo)
  contador = S
  removalset = NULL
  for(i in q){
    if(contador > 0.05 & length(removalset) < vcount(g)/2){
      removalset <- sample(x = V(g)$name, size = 10, replace = F)
      g <- delete.vertices(graph = g, v = removalset)
      S = c(S, max(components(g)$csize)/vcount(grafo))
      
      contador = max(components(g)$csize)/vcount(grafo)
    }
  }
  x <- as.numeric(q[1:length(S)])
  x <- x[!is.na(x)]
  y <- as.numeric(S)
  id <- order(x)
  return(sum(diff(x[id])*rollmean(y[id],2)))
} 
# plot the graph
plot_graph <- function(graph){
  V(graph)$label <- NA
  V(graph)$name <- NA
  V(graph)$size <- degree(graph)/5
  E(graph)$edge.color <- "gray80"
  V(graph)$color <- "tomato"
  # graph_attr(graph, "layout") <- layout_with_lgl
  graph_attr(graph, "layout") <- layout.kamada.kawai
  plot(graph)
  
}
# plot
plot_graph <- function(graph){
  V(graph)$label <- NA
  V(graph)$name <- NA
  V(graph)$size <- degree(graph)/5
  E(graph)$edge.color <- "gray80"
  V(graph)$color <- "tomato"
  # graph_attr(graph, "layout") <- layout_with_lgl
  graph_attr(graph, "layout") <- layout.kamada.kawai
  plot(graph)
  
}
```

## Ataque dirigido

```{r echo=FALSE, warning=FALSE}
targeted <- sequential.attacks.targeted(net_prop, measure = degree)
targeted$attack <- rep("targeted")
```

```{r echo=FALSE, warning=FALSE}
ggplot(targeted, aes(x=q, y=S, color=S)) + geom_point(alpha=.4, size=2) +
  theme_bw() +
  theme(plot.background = element_blank(),  panel.grid.minor = element_blank(),plot.title=element_text(size=15)) +
  geom_line() +
  ggtitle("Ataque secuencial dirigido") +
  ylab("S(q)") +
  xlab("q")
```

```{r}
targeted_score <- robustness.targeted2(net_prop, measure = degree)
targeted_score
```
```{r}
targeted
targeted[targeted$q == '0.1', ]
```


## Ataque aleatorio

```{r warning=FALSE}
random <- sequential.attacks.random(net_prop, measure = degree)
random$attack <- rep("random")
```


```{r warning=FALSE}
ggplot(random, aes(x=q, y=S, color=S)) + geom_point(alpha=.4, size=2) +
  theme_bw() +
  theme(plot.background = element_blank(),  panel.grid.minor = element_blank(),plot.title=element_text(size=15)) +
  geom_line() +
  ggtitle("Ataque secuencial aleatorio") +
  ylab("S(q)") +
  xlab("q")
```

```{r}
random_score <- robustness.random2(net_prop, measure = degree)
random_score
```

## Nodos importantes
```{r}
#calculamos el numero de enlaces que salen de cada vertice
net_degree <- degree(net_prop, mode = c("out"))
(net_degree)
```
```{r}
hist(net_degree, breaks = 20)
```
```{r}
#el nodo con mas enlaces
net_degree[which.max(net_degree)]
```

```{r}
net_betweenness <- betweenness(net_prop, directed = TRUE)
```

```{r}
#plot en el que el tamaño del nodo lo determina el numero de conexiones
plot(net_prop, 
     vertex.label = NA,
     edge.color = 'black',
     vertex.size = sqrt(net_betweenness),
     edge.arrow.size = 0.05,
     layout = layout_nicely(net_prop))
```
```{r}
#calculamos la densidad del grafo; que tan interconectada esta la red
gd <- edge_density(net_prop)
gd
```

```{r}
# promedio de las longitudes de los caminos más cortos entre todos los pares de nodos de la red. entre más pequeño el valor más interconectada la red
g.apl <- mean_distance(net_prop, directed = FALSE)
g.apl
```
```{r}
#plot interactivo por si luego queremos implemetnarlo
library(threejs)
g <- set_vertex_attr(net_prop, "color", value = "dodgerblue")
graphjs(g, vertex.size = 1)
```


```{r}
library(brainGraph)
#ataque dirigido con otra funcion
robustness(net_prop, type = "vertex", measure = 'degree' , N = 1000)
```
```{r}
m1 <- layout_nicely(net_prop)
net_prop
```





```{r}
plot(net_prop, vertex.label.color = "black", layout = m1 )
```
```{r}

```

